<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Rich Text + Signature + Image Fields → PDF</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    :root {
      --primary: #2563eb;
      --radius: 8px;
      --shadow: 0 16px 40px rgba(0, 0, 0, 0.08);
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
    }

    * {
      box-sizing: border-box;
    }

    body {
      background: #eef2f7;
      margin: 0;
      padding: 1rem;
    }

    .card {
      max-width: 1100px;
      margin: auto;
      background: #fff;
      border-radius: 12px;
      padding: 1rem 1.5rem 2rem;
      box-shadow: var(--shadow);
    }

    h1 {
      margin-top: 0;
      font-size: 1.75rem;
    }

    .toolbar {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      align-items: center;
      margin-bottom: 8px;
    }

    .toolbar button,
    .toolbar select,
    .toolbar input[type='color'] {
      border: 1px solid #bbb;
      background: #fff;
      padding: 6px 10px;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
    }

    .toolbar button.active {
      background: var(--primary);
      color: #fff;
      border-color: var(--primary);
    }

    #editor {
      border: 1px solid #ccc;
      min-height: 500px;
      padding: 14px;
      border-radius: 8px;
      overflow: auto;
      position: relative;
    }

    .field-wrapper {
      display: inline-block;
      vertical-align: middle;
      cursor: move;
    }

    .field {
      display: block;
      position: relative;
      user-select: none;
    }

    .sig-field,
    .img-field {
      border: 2px dashed var(--primary);
      background: #f7f9fc;
      border-radius: 6px;
      overflow: hidden;
      position: relative;
    }

    .sig-field {
      width: 200px;
      height: 80px;
    }

    .sig-field .hint,
    .img-field .hint {
      position: absolute;
      inset: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      pointer-events: none;
      font-size: 0.65rem;
      color: #555;
    }

    .img-field {
      width: 160px;
      height: 120px;
    }

    .field-wrapper.dragging {
      opacity: 0.4;
    }

    .resize-handle {
      position: absolute;
      width: 12px;
      height: 12px;
      background: #fff;
      border: 1px solid #666;
      border-radius: 3px;
      right: 2px;
      bottom: 2px;
      cursor: se-resize;
    }

    #signature-modal,
    #image-modal {
      position: fixed;
      inset: 0;
      display: none;
      background: rgba(0, 0, 0, 0.35);
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal {
      background: #fff;
      border-radius: 10px;
      padding: 16px 16px 12px;
      width: 380px;
      box-shadow: 0 30px 60px rgba(0, 0, 0, 0.25);
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    #sig-canvas {
      border: 1px solid #777;
      border-radius: 6px;
      width: 100%;
      height: 140px;
      touch-action: none;
      background: #fff;
      display: block;
    }

    .btn {
      padding: 8px 14px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-size: 0.9rem;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      background: var(--primary);
      color: #fff;
    }

    .secondary {
      background: #f0f0f5;
      color: #333;
      border: 1px solid #ccc;
    }

    .small {
      font-size: 0.75rem;
      color: #555;
    }

    #status {
      margin-top: 6px;
      font-size: 0.85rem;
      color: #555;
    }

    input[type='file'] {
      display: none;
    }
  </style>
</head>
<body>
  <div class="card">
    <h1>Rich Text Editor with Signature & Image Fields</h1>

    <div class="toolbar" aria-label="Formatting toolbar">
      <button data-cmd="bold" title="Bold"><strong>B</strong></button>
      <button data-cmd="italic" title="Italic"><em>I</em></button>
      <button data-cmd="underline" title="Underline"><u>U</u></button>
      <button data-cmd="strikeThrough" title="Strike"><s>S</s></button>
      <select data-cmd="fontSize" title="Font size">
        <option value="1">Small</option>
        <option value="3" selected>Normal</option>
        <option value="5">Large</option>
        <option value="7">XL</option>
      </select>
      <input type="color" data-cmd="foreColor" title="Text color" value="#000000" />
      <button data-cmd="insertUnorderedList" title="Bullet list">&bull; List</button>
      <button data-cmd="undo" title="Undo">↺</button>
      <button data-cmd="redo" title="Redo">↻</button>
      <button id="add-sig-field" title="Add signature field">Add Signature Field</button>
      <button id="add-img-field" title="Add image field">Add Image Field</button>
      <button id="generate-pdf" class="btn" title="Generate PDF">Generate PDF</button>
      <button id="download-pdf" class="btn" style="margin-left: 4px" disabled>Download PDF</button>
      <div class="small">
        Click signature box to sign; drag/rescale image; drag fields anywhere.
      </div>
    </div>

    <div id="editor" contenteditable="true" aria-label="Document editor">
      <p>
        Start writing. Format text, insert signature fields or image fields, then
        export.
      </p>
    </div>
    <div id="status"></div>
  </div>

  <template id="sig-template">
    <span class="field-wrapper" draggable="true">
      <div class="field sig-field" data-signed="false">
        <div class="hint">Click to sign</div>
      </div>
    </span>
  </template>

  <template id="img-template">
    <span class="field-wrapper" draggable="true">
      <div class="field img-field" data-has-image="false">
        <div class="hint">Click to add image</div>
        <div class="resize-handle"></div>
      </div>
    </span>
  </template>

  <div id="signature-modal" aria-label="Signature drawing modal">
    <div class="modal" role="dialog" aria-modal="true">
      <div style="display: flex; justify-content: space-between; align-items: center">
        <div style="font-weight: 600">Draw Signature</div>
        <button
          id="close-sig"
          aria-label="Close"
          style="background: none; border: none; font-size: 1.3rem; cursor: pointer"
        >
          &times;
        </button>
      </div>
      <canvas id="sig-canvas" aria-label="Signature canvas"></canvas>
      <div style="display: flex; gap: 8px; flex-wrap: wrap">
        <button id="clear-signature" class="secondary">Clear</button>
        <button id="save-signature" class="btn">Save Signature</button>
      </div>
      <div class="small">
        Use mouse or touch to draw. Saved image will go into the signature field.
      </div>
    </div>
  </div>

  <input type="file" id="image-input" accept="image/*" />

  <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script>
    // refs
    const editor = document.getElementById('editor');
    const toolbar = document.querySelector('.toolbar');
    const addSigBtn = document.getElementById('add-sig-field');
    const addImgBtn = document.getElementById('add-img-field');
    const generatePdfBtn = document.getElementById('generate-pdf');
    const downloadPdfBtn = document.getElementById('download-pdf');
    const statusDiv = document.getElementById('status');
    const sigTemplate = document.getElementById('sig-template');
    const imgTemplate = document.getElementById('img-template');
    const signatureModal = document.getElementById('signature-modal');
    const sigCanvas = document.getElementById('sig-canvas');
    const saveSignatureBtn = document.getElementById('save-signature');
    const clearSignatureBtn = document.getElementById('clear-signature');
    const closeSigBtn = document.getElementById('close-sig');
    const imageInput = document.getElementById('image-input');
    const { jsPDF } = window.jspdf;

    let activeSigField = null;
    let lastPdfBlobUrl = null;

    // Rich text toolbar
    toolbar.addEventListener('click', (e) => {
      const btn = e.target.closest('button');
      if (!btn) return;
      const cmd = btn.dataset.cmd;
      if (cmd) {
        document.execCommand(cmd, false, null);
        refreshToolbarState();
      }
    });

    toolbar.addEventListener('input', (e) => {
      const target = e.target;
      const cmd = target.dataset.cmd;
      if (!cmd) return;
      if (cmd === 'fontSize')
        document.execCommand('fontSize', false, target.value);
      else if (cmd === 'foreColor')
        document.execCommand('foreColor', false, target.value);
      refreshToolbarState();
    });

    function refreshToolbarState() {
      ['bold', 'italic', 'underline', 'strikeThrough', 'insertUnorderedList'].forEach(
        (c) => {
          const b = toolbar.querySelector(`[data-cmd="${c}"]`);
          if (b) {
            if (document.queryCommandState(c)) b.classList.add('active');
            else b.classList.remove('active');
          }
        }
      );
      const fontSizeSelect = toolbar.querySelector('[data-cmd="fontSize"]');
      if (fontSizeSelect) {
        let size = document.queryCommandValue('fontSize');
        if (size) {
          fontSizeSelect.value = size;
        }
      }
    }

    editor.addEventListener('keyup', refreshToolbarState);
    editor.addEventListener('mouseup', refreshToolbarState);

    // Signature canvas setup
    const ctx = sigCanvas.getContext('2d');
    let drawing = false;

    function resizeCanvas() {
      const dpr = window.devicePixelRatio || 1;
      const w = sigCanvas.clientWidth;
      const h = 140;
      sigCanvas.width = w * dpr;
      sigCanvas.height = h * dpr;
      sigCanvas.style.width = w + 'px';
      sigCanvas.style.height = h + 'px';
      ctx.setTransform(dpr, 0, 0, dpr, 0, 0);
      ctx.lineWidth = 2.2;
      ctx.lineCap = 'round';
      ctx.strokeStyle = '#222';
      ctx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
    }
    resizeCanvas();
    window.addEventListener('resize', resizeCanvas);

    function getPointer(e) {
      const rect = sigCanvas.getBoundingClientRect();
      const clientX = e.touches ? e.touches[0].clientX : e.clientX;
      const clientY = e.touches ? e.touches[0].clientY : e.clientY;
      return { x: clientX - rect.left, y: clientY - rect.top };
    }

    sigCanvas.addEventListener('pointerdown', (e) => {
      e.preventDefault();
      drawing = true;
      const { x, y } = getPointer(e);
      ctx.beginPath();
      ctx.moveTo(x, y);
    });

    sigCanvas.addEventListener('pointermove', (e) => {
      if (!drawing) return;
      e.preventDefault();
      const { x, y } = getPointer(e);
      ctx.lineTo(x, y);
      ctx.stroke();
    });

    sigCanvas.addEventListener('pointerup', () => (drawing = false));
    sigCanvas.addEventListener('pointerleave', () => (drawing = false));

    clearSignatureBtn.addEventListener('click', () => {
      ctx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
    });

    closeSigBtn.addEventListener('click', () => {
      signatureModal.style.display = 'none';
      activeSigField = null;
    });

    signatureModal.addEventListener('click', (e) => {
      if (e.target === signatureModal) {
        signatureModal.style.display = 'none';
        activeSigField = null;
      }
    });

    // Field attaching helpers
    function makeDraggable(wrapper) {
      wrapper.addEventListener('dragstart', (e) => {
        e.dataTransfer.setData('text/plain', 'field');
        wrapper.classList.add('dragging');
      });
      wrapper.addEventListener('dragend', () => {
        wrapper.classList.remove('dragging');
      });
    }

    function attachSignatureField(wrapper) {
      makeDraggable(wrapper);
      const field = wrapper.querySelector('.sig-field');
      field.addEventListener('click', (e) => {
        e.stopPropagation();
        activeSigField = field;
        resizeCanvas();
        ctx.clearRect(0, 0, sigCanvas.width, sigCanvas.height);
        signatureModal.style.display = 'flex';
      });
    }

    function attachImageField(wrapper) {
      makeDraggable(wrapper);
      const field = wrapper.querySelector('.img-field');
      const handle = field.querySelector('.resize-handle');
      let resizing = false;
      let startW, startH, startX, startY;

      // Resize
      handle.addEventListener('pointerdown', (e) => {
        e.preventDefault();
        e.stopPropagation();
        resizing = true;
        startW = field.offsetWidth;
        startH = field.offsetHeight;
        startX = e.clientX;
        startY = e.clientY;
        document.body.style.cursor = 'se-resize';
      });

      window.addEventListener('pointermove', (e) => {
        if (!resizing) return;
        const dx = e.clientX - startX;
        const dy = e.clientY - startY;
        field.style.width = Math.max(60, startW + dx) + 'px';
        field.style.height = Math.max(40, startH + dy) + 'px';
      });

      window.addEventListener('pointerup', () => {
        if (resizing) {
          resizing = false;
          document.body.style.cursor = '';
        }
      });

      // click to add/change image
      field.addEventListener('click', (e) => {
        e.stopPropagation();
        imageInput.click();
      });

      imageInput.addEventListener('change', (evt) => {
        const file = evt.target.files[0];
        if (!file) return;
        const url = URL.createObjectURL(file);
        field.innerHTML = '';
        const img = document.createElement('img');
        img.src = url;
        img.style.width = '100%';
        img.style.height = '100%';
        img.style.objectFit = 'contain';
        img.alt = 'Inserted image';
        field.appendChild(img);
        field.appendChild(handle);
        field.dataset.hasImage = 'true';
        imageInput.value = ''; // clear input to allow same file to be selected again
      });
    }

    // Add new signature field at caret
    addSigBtn.addEventListener('click', () => {
      const clone = sigTemplate.content.firstElementChild.cloneNode(true);
      attachSignatureField(clone);
      insertAtCaret(clone);
    });

    // Add new image field
    addImgBtn.addEventListener('click', () => {
      const clone = imgTemplate.content.firstElementChild.cloneNode(true);
      attachImageField(clone);
      insertAtCaret(clone);
    });

    // caret insertion helper
    function insertAtCaret(node) {
      const sel = window.getSelection();
      if (sel && sel.rangeCount) {
        const range = sel.getRangeAt(0);
        range.collapse(false);
        range.insertNode(node);
        range.setStartAfter(node);
        sel.removeAllRanges();
        sel.addRange(range);
      } else {
        editor.appendChild(node);
      }
    }

    // allow field repositioning via drop
    editor.addEventListener('dragover', (e) => e.preventDefault());
    editor.addEventListener('drop', (e) => {
      e.preventDefault();
      const dragging = document.querySelector('.field-wrapper.dragging');
      if (!dragging) return;
      const x = e.clientX;
      const y = e.clientY;
      let range = null;
      if (document.caretRangeFromPoint) {
        range = document.caretRangeFromPoint(x, y);
      } else if (document.caretPositionFromPoint) {
        const pos = document.caretPositionFromPoint(x, y);
        range = document.createRange();
        range.setStart(pos.offsetNode, pos.offset);
      }
      if (range) {
        range.insertNode(dragging);
      } else {
        editor.appendChild(dragging);
      }
    });

    // Save signature into field
    saveSignatureBtn.addEventListener('click', () => {
      if (!activeSigField) return;
      const dataUrl = sigCanvas.toDataURL('image/png');
      activeSigField.innerHTML = '';
      const img = document.createElement('img');
      img.src = dataUrl;
      img.alt = 'Signature';
      img.style.width = '100%';
      img.style.height = '100%';
      img.style.objectFit = 'contain';
      activeSigField.appendChild(img);
      activeSigField.dataset.signed = 'true';
      signatureModal.style.display = 'none';
      activeSigField = null;
    });

    // Initialize existing fields on page load (if any)
    document
      .querySelectorAll('.field-wrapper')
      .forEach((wrapper) => {
        if (wrapper.querySelector('.sig-field')) {
          attachSignatureField(wrapper);
        } else if (wrapper.querySelector('.img-field')) {
          attachImageField(wrapper);
        }
      });

    // PDF generation (improved)
    generatePdfBtn.addEventListener('click', async () => {
      statusDiv.textContent = 'Generating PDF...';
      downloadPdfBtn.disabled = true;

      const pdf = new jsPDF('p', 'pt', 'a4');
      const pdfWidth = pdf.internal.pageSize.getWidth();
      const pdfHeight = pdf.internal.pageSize.getHeight();
      const margin = 40; // a decent margin

      // Temporarily hide hints and resize handles for a cleaner snapshot
      const hints = document.querySelectorAll('.hint');
      const handles = document.querySelectorAll('.resize-handle');
      hints.forEach((h) => (h.style.display = 'none'));
      handles.forEach((h) => (h.style.display = 'none'));

      // html2canvas will render the whole editor content as a single image.
      // We must ensure all images are loaded first.
      await ensureImagesLoaded(editor);

      try {
        const canvas = await html2canvas(editor, {
          scale: 2,
          backgroundColor: '#ffffff',
          logging: false,
          useCORS: true,
        });

        const imgData = canvas.toDataURL('image/jpeg', 1.0);
        const imgWidth = pdfWidth - 2 * margin;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        let position = margin;
        let heightLeft = imgHeight;

        pdf.addImage(imgData, 'JPEG', margin, position, imgWidth, imgHeight);
        heightLeft -= (pdfHeight - 2 * margin);

        while (heightLeft > 0) {
          position = heightLeft - imgHeight;
          pdf.addPage();
          pdf.addImage(imgData, 'JPEG', margin, position, imgWidth, imgHeight);
          heightLeft -= (pdfHeight - 2 * margin);
        }
        
        // Output the PDF
        const blob = pdf.output('blob');
        if (lastPdfBlobUrl) URL.revokeObjectURL(lastPdfBlobUrl);
        lastPdfBlobUrl = URL.createObjectURL(blob);
        
        statusDiv.textContent = 'PDF ready.';
        downloadPdfBtn.disabled = false;
      } catch (err) {
        console.error('PDF generation error:', err);
        statusDiv.textContent = 'Failed to generate PDF: ' + (err.message || 'unknown');
      } finally {
        // Restore hidden elements
        hints.forEach((h) => (h.style.display = 'flex'));
        handles.forEach((h) => (h.style.display = 'block'));
      }
    });

    downloadPdfBtn.addEventListener('click', () => {
      if (!lastPdfBlobUrl) return;
      const a = document.createElement('a');
      a.href = lastPdfBlobUrl;
      a.download = 'document_signed.pdf';
      a.click();
    });

    // wait for any <img> inside to finish loading
    function ensureImagesLoaded(el) {
      const imgs = Array.from(el.querySelectorAll('img'));
      return Promise.all(
        imgs.map((img) => {
          if (img.complete) return Promise.resolve();
          return new Promise((res) => {
            img.onload = () => res();
            img.onerror = () => res(); // ignore broken
          });
        })
      );
    }

    // click outside to unfocus
    document.body.addEventListener('click', () => {
      refreshToolbarState();
    });
  </script>
</body>
</html>
